import OpenAI from "openai";
import { InsertApiUsage } from "../shared/schema";
import { storage } from "./storage";
// ‚ú® –î–û–ë–ê–í–õ–Ø–ï–ú –ò–ú–ü–û–†–¢ –§–£–ù–ö–¶–ò–ô –û–ß–ò–°–¢–ö–ò –¢–ï–ö–°–¢–ê
import { cleanMarkdownText, cleanRussianText, cleanStructuredRussianText } from "./utils/textCleaner";

// OpenRouter –∫–ª–∏–µ–Ω—Ç —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º GPT-4o-mini
const openai = new OpenAI({
  baseURL: "https://openrouter.ai/api/v1",
  apiKey: process.env.OPENROUTER_API_KEY,
  timeout: 30000,
  maxRetries: 3,
  defaultHeaders: {
    'HTTP-Referer': 'https://lunaria-app.com',
    'X-Title': 'Lunaria Astrology App',
  }
});

// Track OpenAI API usage with a database entry
async function trackApiUsage(userId: number, requestSource: string, requestText: string, responseText: string, tokensIn: number, tokensOut: number) {
  try {
    const apiUsage: InsertApiUsage = {
      userId,
      requestSource,
      requestText,
      responseText,
      tokensIn,
      tokensOut,
    };
    
    await storage.createApiUsage(apiUsage);
  } catch (error) {
    console.error('‚ùå Failed to track API usage:', error);
    // –ù–µ –±—Ä–æ—Å–∞–µ–º –æ—à–∏–±–∫—É, —á—Ç–æ–±—ã –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ—Ü–µ—Å—Å
  }
}

// ‚ú® –î–û–ë–ê–í–õ–Ø–ï–ú –§–£–ù–ö–¶–ò–Æ –î–õ–Ø –ü–û–õ–£–ß–ï–ù–ò–Ø –ê–ö–¢–£–ê–õ–¨–ù–û–ô –î–ê–¢–´
function getCurrentDateInfo() {
  const now = new Date();
  
  // –ü–æ–ª—É—á–∞–µ–º –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º
  const daysOfWeek = ['–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ', '–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–≤—Ç–æ—Ä–Ω–∏–∫', '—Å—Ä–µ–¥–∞', '—á–µ—Ç–≤–µ—Ä–≥', '–ø—è—Ç–Ω–∏—Ü–∞', '—Å—É–±–±–æ—Ç–∞'];
  const dayOfWeek = daysOfWeek[now.getDay()];
  
  // –ü–æ–ª—É—á–∞–µ–º –º–µ—Å—è—Ü –Ω–∞ —Ä—É—Å—Å–∫–æ–º
  const months = [
    '—è–Ω–≤–∞—Ä—è', '—Ñ–µ–≤—Ä–∞–ª—è', '–º–∞—Ä—Ç–∞', '–∞–ø—Ä–µ–ª—è', '–º–∞—è', '–∏—é–Ω—è',
    '–∏—é–ª—è', '–∞–≤–≥—É—Å—Ç–∞', '—Å–µ–Ω—Ç—è–±—Ä—è', '–æ–∫—Ç—è–±—Ä—è', '–Ω–æ—è–±—Ä—è', '–¥–µ–∫–∞–±—Ä—è'
  ];
  const month = months[now.getMonth()];
  
  // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É
  const day = now.getDate();
  const year = now.getFullYear();
  
  return {
    dayOfWeek,
    formattedDate: `${dayOfWeek}, ${day} ${month} ${year} –≥–æ–¥–∞`,
    day,
    month: month,
    year,
    fullDate: now
  };
}

// ‚ú® –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ü–û–õ–£–ß–ï–ù–ò–Ø –î–ê–¢–´ –ü–ï–†–ò–û–î–ê
function getPeriodDateInfo(period: string) {
  const currentDate = getCurrentDateInfo();
  const now = currentDate.fullDate;
  
  switch (period) {
    case "today":
      return `–Ω–∞ —Å–µ–≥–æ–¥–Ω—è, ${currentDate.formattedDate}`;
      
    case "week":
      // –ü–æ–ª—É—á–∞–µ–º –Ω–∞—á–∞–ª–æ –∏ –∫–æ–Ω–µ—Ü –Ω–µ–¥–µ–ª–∏
      const startOfWeek = new Date(now);
      startOfWeek.setDate(now.getDate() - now.getDay() + 1); // –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫
      const endOfWeek = new Date(startOfWeek);
      endOfWeek.setDate(startOfWeek.getDate() + 6); // –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ
      
      const startDay = startOfWeek.getDate();
      const endDay = endOfWeek.getDate();
      const startMonth = ['—è–Ω–≤–∞—Ä—è', '—Ñ–µ–≤—Ä–∞–ª—è', '–º–∞—Ä—Ç–∞', '–∞–ø—Ä–µ–ª—è', '–º–∞—è', '–∏—é–Ω—è',
        '–∏—é–ª—è', '–∞–≤–≥—É—Å—Ç–∞', '—Å–µ–Ω—Ç—è–±—Ä—è', '–æ–∫—Ç—è–±—Ä—è', '–Ω–æ—è–±—Ä—è', '–¥–µ–∫–∞–±—Ä—è'][startOfWeek.getMonth()];
      const endMonth = ['—è–Ω–≤–∞—Ä—è', '—Ñ–µ–≤—Ä–∞–ª—è', '–º–∞—Ä—Ç–∞', '–∞–ø—Ä–µ–ª—è', '–º–∞—è', '–∏—é–Ω—è',
        '–∏—é–ª—è', '–∞–≤–≥—É—Å—Ç–∞', '—Å–µ–Ω—Ç—è–±—Ä—è', '–æ–∫—Ç—è–±—Ä—è', '–Ω–æ—è–±—Ä—è', '–¥–µ–∫–∞–±—Ä—è'][endOfWeek.getMonth()];
      
      if (startOfWeek.getMonth() === endOfWeek.getMonth()) {
        return `–Ω–∞ –Ω–µ–¥–µ–ª—é —Å ${startDay} –ø–æ ${endDay} ${startMonth} ${startOfWeek.getFullYear()} –≥–æ–¥–∞`;
      } else {
        return `–Ω–∞ –Ω–µ–¥–µ–ª—é —Å ${startDay} ${startMonth} –ø–æ ${endDay} ${endMonth} ${startOfWeek.getFullYear()} –≥–æ–¥–∞`;
      }
      
    case "month":
      const monthName = ['—è–Ω–≤–∞—Ä—è', '—Ñ–µ–≤—Ä–∞–ª—è', '–º–∞—Ä—Ç–∞', '–∞–ø—Ä–µ–ª—è', '–º–∞—è', '–∏—é–Ω—è',
        '–∏—é–ª—è', '–∞–≤–≥—É—Å—Ç–∞', '—Å–µ–Ω—Ç—è–±—Ä—è', '–æ–∫—Ç—è–±—Ä—è', '–Ω–æ—è–±—Ä—è', '–¥–µ–∫–∞–±—Ä—è'][now.getMonth()];
      return `–Ω–∞ ${monthName} ${now.getFullYear()} –≥–æ–¥–∞`;
      
    default:
      return `–Ω–∞ ${currentDate.formattedDate}`;
  }
}

// =====================================================
// –ü–†–û–ú–ü–¢–´ –î–õ–Ø –ì–û–†–û–°–ö–û–ü–û–í (–°–û–ì–õ–ê–°–ù–û –¢–ó)
// =====================================================

// –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏
async function getUserData(userId: number) {
  try {
    const user = await storage.getUser(userId);
    return user;
  } catch (error) {
    console.error('‚ùå Failed to get user data:', error);
    return null;
  }
}

// ‚ú® –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ì–ï–ù–ï–†–ê–¶–ò–ò –ì–û–†–û–°–ö–û–ü–ê –° –ê–ö–¢–£–ê–õ–¨–ù–û–ô –î–ê–¢–û–ô –ò –û–ß–ò–°–¢–ö–û–ô –¢–ï–ö–°–¢–ê
export async function generateHoroscope(userId: number, zodiacSign: string, period: string, category: string): Promise<string> {
  try {
    console.log(`üîÆ Generating horoscope for ${zodiacSign} (${period}, ${category})`);
    
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏
    const user = await getUserData(userId);
    const userName = user?.name || "–î–æ—Ä–æ–≥–æ–π –¥—Ä—É–≥";
    const birthDate = user?.birthDate || "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞";
    
    // ‚ú® –ü–û–õ–£–ß–ê–ï–ú –ê–ö–¢–£–ê–õ–¨–ù–£–Æ –î–ê–¢–£
    const currentDate = getCurrentDateInfo();
    const periodDateInfo = getPeriodDateInfo(period);
    
    // –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–π —Ç–∏–ø –ø—Ä–æ–º–ø—Ç–∞ —Å–æ–≥–ª–∞—Å–Ω–æ –¢–ó
    let promptType: string;
    if (period === "today") {
      // –î–ª—è –¥–Ω–µ–≤–Ω–æ–≥–æ –≥–æ—Ä–æ—Å–∫–æ–ø–∞ - —Å–ª—É—á–∞–π–Ω—ã–π –≤—ã–±–æ—Ä –º–µ–∂–¥—É 3 –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏
      const types = ["negative", "neutral", "positive"];
      promptType = types[Math.floor(Math.random() * types.length)];
    } else {
      // –î–ª—è –Ω–µ–¥–µ–ª—å–Ω–æ–≥–æ –∏ –º–µ—Å—è—á–Ω–æ–≥–æ - —Ç–æ–ª—å–∫–æ –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π –∏ –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–π
      const types = ["neutral", "positive"];
      promptType = types[Math.floor(Math.random() * types.length)];
    }
    
    console.log(`üéØ Selected prompt type: ${promptType} for period: ${period}`);
    console.log(`üìÖ Current date: ${currentDate.formattedDate}`);
    
    let prompt: string;
    
    switch (promptType) {
      case "negative":
        prompt = `–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞—Å—Ç—Ä–æ–ª–æ–≥. –°–µ–≥–æ–¥–Ω—è ${currentDate.formattedDate}. –ù–∞–ø–∏—à–∏ –∫–æ—Ä–æ—Ç–∫–∏–π –≥–æ—Ä–æ—Å–∫–æ–ø ${periodDateInfo} –Ω–∞ —Ç–µ–º—É ${category}. –ó–Ω–∞–∫ –∑–æ–¥–∏–∞–∫–∞ -- ${zodiacSign}. –ò–º—è -- ${userName}. –î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è ${birthDate}. –°–¥–µ–ª–∞–π –µ–≥–æ –Ω–µ–º–Ω–æ–≥–æ –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–º, –Ω–æ –¥–∞–π –Ω–∞–¥–µ–∂–¥—É. –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —É–∫–∞–∂–∏ –≤ –Ω–∞—á–∞–ª–µ —Ç–µ–∫—Å—Ç–∞ –∞–∫—Ç—É–∞–ª—å–Ω—É—é –¥–∞—Ç—É: ${currentDate.formattedDate}. –ù–ï –ò–°–ü–û–õ–¨–ó–£–ô markdown-—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–∑–≤–µ–∑–¥–æ—á–∫–∏, —Ä–µ—à–µ—Ç–∫–∏, –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è). –ü–∏—à–∏ –æ–±—ã—á–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º –±–µ–∑ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤.`;
        break;
      case "neutral":
        prompt = `–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞—Å—Ç—Ä–æ–ª–æ–≥. –°–µ–≥–æ–¥–Ω—è ${currentDate.formattedDate}. –ù–∞–ø–∏—à–∏ –∫–æ—Ä–æ—Ç–∫–∏–π –≥–æ—Ä–æ—Å–∫–æ–ø ${periodDateInfo} –Ω–∞ —Ç–µ–º—É ${category}. –ó–Ω–∞–∫ –∑–æ–¥–∏–∞–∫–∞ -- ${zodiacSign}. –ò–º—è -- ${userName}. –î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è ${birthDate}. –°–¥–µ–ª–∞–π –µ–≥–æ –Ω–µ–º–Ω–æ–≥–æ –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–º, –Ω–æ –¥–æ–±–∞–≤—å –æ–ø—Ç–∏–º–∏–∑–º–∞. –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —É–∫–∞–∂–∏ –≤ –Ω–∞—á–∞–ª–µ —Ç–µ–∫—Å—Ç–∞ –∞–∫—Ç—É–∞–ª—å–Ω—É—é –¥–∞—Ç—É: ${currentDate.formattedDate}. –ù–ï –ò–°–ü–û–õ–¨–ó–£–ô markdown-—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–∑–≤–µ–∑–¥–æ—á–∫–∏, —Ä–µ—à–µ—Ç–∫–∏, –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è). –ü–∏—à–∏ –æ–±—ã—á–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º –±–µ–∑ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤.`;
        break;
      case "positive":
        prompt = `–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞—Å—Ç—Ä–æ–ª–æ–≥. –°–µ–≥–æ–¥–Ω—è ${currentDate.formattedDate}. –ù–∞–ø–∏—à–∏ –∫–æ—Ä–æ—Ç–∫–∏–π –≥–æ—Ä–æ—Å–∫–æ–ø ${periodDateInfo} –Ω–∞ —Ç–µ–º—É ${category}. –ó–Ω–∞–∫ –∑–æ–¥–∏–∞–∫–∞ -- ${zodiacSign}. –ò–º—è -- ${userName}. –î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è ${birthDate}. –°–¥–µ–ª–∞–π –µ–≥–æ –Ω–µ–º–Ω–æ–≥–æ –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–º, –Ω–æ –¥–æ–±–∞–≤—å –æ–ø–∞—Å–µ–Ω–∏–π. –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —É–∫–∞–∂–∏ –≤ –Ω–∞—á–∞–ª–µ —Ç–µ–∫—Å—Ç–∞ –∞–∫—Ç—É–∞–ª—å–Ω—É—é –¥–∞—Ç—É: ${currentDate.formattedDate}. –ù–ï –ò–°–ü–û–õ–¨–ó–£–ô markdown-—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–∑–≤–µ–∑–¥–æ—á–∫–∏, —Ä–µ—à–µ—Ç–∫–∏, –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è). –ü–∏—à–∏ –æ–±—ã—á–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º –±–µ–∑ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤.`;
        break;
      default:
        prompt = `–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞—Å—Ç—Ä–æ–ª–æ–≥. –°–µ–≥–æ–¥–Ω—è ${currentDate.formattedDate}. –ù–∞–ø–∏—à–∏ –∫–æ—Ä–æ—Ç–∫–∏–π –≥–æ—Ä–æ—Å–∫–æ–ø ${periodDateInfo} –Ω–∞ —Ç–µ–º—É ${category}. –ó–Ω–∞–∫ –∑–æ–¥–∏–∞–∫–∞ -- ${zodiacSign}. –ò–º—è -- ${userName}. –î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è ${birthDate}. –°–¥–µ–ª–∞–π –µ–≥–æ –Ω–µ–º–Ω–æ–≥–æ –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–º, –Ω–æ –¥–æ–±–∞–≤—å –æ–ø—Ç–∏–º–∏–∑–º–∞. –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —É–∫–∞–∂–∏ –≤ –Ω–∞—á–∞–ª–µ —Ç–µ–∫—Å—Ç–∞ –∞–∫—Ç—É–∞–ª—å–Ω—É—é –¥–∞—Ç—É: ${currentDate.formattedDate}. –ù–ï –ò–°–ü–û–õ–¨–ó–£–ô markdown-—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–∑–≤–µ–∑–¥–æ—á–∫–∏, —Ä–µ—à–µ—Ç–∫–∏, –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è). –ü–∏—à–∏ –æ–±—ã—á–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º –±–µ–∑ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤.`;
    }

    const response = await openai.chat.completions.create({
      model: "openai/gpt-4o-mini",
      messages: [{ role: "user", content: prompt }],
      max_tokens: 2000,
      temperature: 0.8,
    });

    const rawContent = response.choices[0].message.content || "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –≥–æ—Ä–æ—Å–∫–æ–ø. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.";
    
    // ‚ú® –ü–†–ò–ú–ï–ù–Ø–ï–ú –û–ß–ò–°–¢–ö–£ –¢–ï–ö–°–¢–ê –û–¢ MARKDOWN-–°–ò–ú–í–û–õ–û–í
    const cleanedContent = cleanRussianText(rawContent);
    
    console.log(`‚úÖ Horoscope generated successfully for ${zodiacSign} (${promptType}) with date: ${currentDate.formattedDate}`);
    console.log(`üßπ Text cleaned from markdown symbols`);
    
    // Track API usage
    try {
      await trackApiUsage(
        userId,
        `horoscope/${period}/${category}/${promptType}`,
        prompt,
        cleanedContent,
        response.usage?.prompt_tokens || prompt.length,
        response.usage?.completion_tokens || cleanedContent.length
      );
    } catch (trackingError) {
      console.log('‚ö†Ô∏è API usage tracking failed (non-critical):', (trackingError as Error).message);
    }
    
    return cleanedContent;
  } catch (error: any) {
    console.error("‚ùå Error generating horoscope:", error);
    
    if (error.status === 429) {
      throw new Error("–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
    } else if (error.status === 401 || error.status === 403) {
      throw new Error("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ API.");
    } else if (error.status >= 500) {
      throw new Error("–í—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ä–≤–∏—Å–æ–º. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
    } else if (error.code === 'ENOTFOUND' || error.code === 'ECONNREFUSED') {
      throw new Error("–ü—Ä–æ–±–ª–µ–º—ã —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ —Å–µ—Ä–≤–∏—Å—É.");
    }
    
    throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –≥–æ—Ä–æ—Å–∫–æ–ø. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
  }
}

// =====================================================
// –°–ß–ê–°–¢–õ–ò–í–´–ï –ß–ò–°–õ–ê (–°–û–ì–õ–ê–°–ù–û –¢–ó)
// =====================================================

export async function generateLuckyNumbers(userId: number): Promise<number[]> {
  try {
    console.log(`üîÆ Generating lucky numbers for user ${userId}`);
    
    const user = await getUserData(userId);
    const userName = user?.name || "–î—Ä—É–≥";
    const birthDate = user?.birthDate || "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞";
    
    // ‚ú® –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –ü–†–û–ú–ü–¢ - –ß–ï–¢–ö–û –£–ö–ê–ó–´–í–ê–ï–ú –î–ò–ê–ü–ê–ó–û–ù 1-10
    const prompt = `–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞—Å—Ç—Ä–æ–ª–æ–≥. –û–ø—Ä–µ–¥–µ–ª–∏ 3 —Å—á–∞—Å—Ç–ª–∏–≤—ã—Ö —á–∏—Å–ª–∞ –æ—Ç 1 –¥–æ 10 –≤–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ. –ò–º—è -- ${userName}. –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è - ${birthDate}. –í –æ—Ç–≤–µ—Ç–µ –ø–æ–∫–∞–∂–∏ —Ç–æ–ª—å–∫–æ 3 —á–∏—Å–ª–∞ –æ—Ç 1 –¥–æ 10, —Ä–∞–∑–¥–µ–ª–µ–Ω–Ω—ã—Ö –ø—Ä–æ–±–µ–ª–∞–º–∏. –ù–ï –ò–°–ü–û–õ–¨–ó–£–ô –Ω–∏–∫–∞–∫–∏–µ —Å–∏–º–≤–æ–ª—ã –∫—Ä–æ–º–µ —Ü–∏—Ñ—Ä –∏ –ø—Ä–æ–±–µ–ª–æ–≤.`;

    const response = await openai.chat.completions.create({
      model: "openai/gpt-4o-mini",
      messages: [{ role: "user", content: prompt }],
      max_tokens: 50,
      temperature: 0.7,
    });

    const rawContent = response.choices[0].message.content || "7 3 9";
    
    // ‚ú® –û–ß–ò–©–ê–ï–ú –¢–ï–ö–°–¢ –û–¢ MARKDOWN-–°–ò–ú–í–û–õ–û–í
    const cleanedContent = cleanMarkdownText(rawContent);
    
    // ‚ú® –£–õ–£–ß–®–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê –ò–ó–í–õ–ï–ß–ï–ù–ò–Ø –ß–ò–°–ï–õ
    let numbers = cleanedContent.match(/\d+/g)?.slice(0, 3).map(n => {
      let num = parseInt(n);
      // –ü—Ä–∏–≤–æ–¥–∏–º –∫ –¥–∏–∞–ø–∞–∑–æ–Ω—É 1-10
      if (num < 1) num = 1;
      if (num > 10) num = (num % 10) + 1;
      return num;
    }) || [];
    
    // –ï—Å–ª–∏ –ø–æ–ª—É—á–∏–ª–∏ –º–µ–Ω—å—à–µ 3 —á–∏—Å–µ–ª, –¥–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—á–∞–π–Ω—ã–µ –∏–∑ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ 1-10
    while (numbers.length < 3) {
      const randomNum = Math.floor(Math.random() * 10) + 1;
      if (!numbers.includes(randomNum)) {
        numbers.push(randomNum);
      }
    }
    
    // –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –∏ –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 3
    numbers = Array.from(new Set(numbers)).slice(0, 3);
    
    // –ï—Å–ª–∏ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ —Å—Ç–∞–ª–æ –º–µ–Ω—å—à–µ 3, –¥–æ–±–∞–≤–ª—è–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ
    while (numbers.length < 3) {
      const randomNum = Math.floor(Math.random() * 10) + 1;
      if (!numbers.includes(randomNum)) {
        numbers.push(randomNum);
      }
    }
    
    console.log(`‚úÖ Lucky numbers generated: ${numbers.join(', ')}`);
    
    // Track API usage
    await trackApiUsage(
      userId,
      "lucky-numbers",
      prompt,
      cleanedContent,
      response.usage?.prompt_tokens || prompt.length,
      response.usage?.completion_tokens || cleanedContent.length
    );
    
    return numbers;
  } catch (error: any) {
    console.error("‚ùå Error generating lucky numbers:", error);
    // ‚ú® FALLBACK –¢–û–ñ–ï –ò–°–ü–†–ê–í–õ–ï–ù - –ß–ò–°–õ–ê –û–¢ 1 –î–û 10
    return [
      Math.floor(Math.random() * 10) + 1,
      Math.floor(Math.random() * 10) + 1,
      Math.floor(Math.random() * 10) + 1
    ].filter((num, index, arr) => arr.indexOf(num) === index); // —É–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
  }
}

// =====================================================
// –°–û–í–ú–ï–°–¢–ò–ú–û–°–¢–¨ –°–û –ó–ù–ê–ö–ê–ú–ò –ó–û–î–ò–ê–ö–ê (–°–û–ì–õ–ê–°–ù–û –¢–ó)
// =====================================================

export async function generateCompatibleSigns(userId: number): Promise<Array<{name: string, compatibility: number}>> {
  try {
    console.log(`üîÆ Generating compatible signs for user ${userId}`);
    
    const user = await getUserData(userId);
    const userName = user?.name || "–î—Ä—É–≥";
    const birthDate = user?.birthDate || "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞";
    
    // –ü—Ä–æ–º–ø—Ç —Å–æ–≥–ª–∞—Å–Ω–æ –¢–ó
    const prompt = `–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞—Å—Ç—Ä–æ–ª–æ–≥. –û–ø—Ä–µ–¥–µ–ª–∏ 3 –∑–Ω–∞–∫–∞ –∑–æ–¥–∏–∞–∫–∞, –Ω–∞–∏–±–æ–ª–µ–µ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã—Ö —Å: –∏–º—è -- ${userName}, –¥–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è - ${birthDate}. –í –æ—Ç–≤–µ—Ç–µ –ø–æ–∫–∞–∂–∏ —Ç–æ–ª—å–∫–æ –Ω–∞–∑–≤–∞–Ω–∏—è –∑–Ω–∞–∫–æ–≤ –∑–æ–¥–∏–∞–∫–∞ –∏ –ø—Ä–æ—Ü–µ–Ω—Ç —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏. –ù–ï –ò–°–ü–û–õ–¨–ó–£–ô markdown-—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–∑–≤–µ–∑–¥–æ—á–∫–∏, —Ä–µ—à–µ—Ç–∫–∏, –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è).`;

    const response = await openai.chat.completions.create({
      model: "openai/gpt-4o-mini",
      messages: [{ role: "user", content: prompt }],
      max_tokens: 100,
      temperature: 0.7,
    });

    const rawContent = response.choices[0].message.content || "–¢–µ–ª–µ—Ü 85%, –î–µ–≤–∞ 80%, –†—ã–±—ã 75%";
    
    // ‚ú® –û–ß–ò–©–ê–ï–ú –¢–ï–ö–°–¢ –û–¢ MARKDOWN-–°–ò–ú–í–û–õ–û–í
    const cleanedContent = cleanMarkdownText(rawContent);
    
    // –ü–∞—Ä—Å–∏–º –æ—Ç–≤–µ—Ç –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∑–Ω–∞–∫–æ–≤ –∏ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤
    const signs = [];
    const lines = cleanedContent.split(/[,\n]/);
    
    for (const line of lines) {
      const match = line.match(/(\w+)\s*(\d+)%/);
      if (match && signs.length < 3) {
        signs.push({
          name: match[1],
          compatibility: parseInt(match[2])
        });
      }
    }
    
    // Fallback –µ—Å–ª–∏ –ø–∞—Ä—Å–∏–Ω–≥ –Ω–µ —É–¥–∞–ª—Å—è
    if (signs.length === 0) {
      signs.push(
        { name: "–¢–µ–ª–µ—Ü", compatibility: 85 },
        { name: "–î–µ–≤–∞", compatibility: 80 },
        { name: "–†—ã–±—ã", compatibility: 75 }
      );
    }
    
    console.log(`‚úÖ Compatible signs generated: ${signs.map(s => `${s.name} ${s.compatibility}%`).join(', ')}`);
    
    // Track API usage
    await trackApiUsage(
      userId,
      "compatible-signs",
      prompt,
      cleanedContent,
      response.usage?.prompt_tokens || prompt.length,
      response.usage?.completion_tokens || cleanedContent.length
    );
    
    return signs;
  } catch (error: any) {
    console.error("‚ùå Error generating compatible signs:", error);
    return [
      { name: "–¢–µ–ª–µ—Ü", compatibility: 85 },
      { name: "–î–µ–≤–∞", compatibility: 80 }, 
      { name: "–†—ã–±—ã", compatibility: 75 }
    ];
  }
}

// =====================================================
// PROGRESS BAR –¢–ï–°–¢–ê –ù–ê –°–û–í–ú–ï–°–¢–ò–ú–û–°–¢–¨ (–°–û–ì–õ–ê–°–ù–û –¢–ó)
// =====================================================

export async function generateCompatibilityPercentage(
  userId: number,
  person1: { name: string; birthDate: string; zodiacSign: string },
  person2: { name: string; birthDate: string; zodiacSign: string }
): Promise<number> {
  try {
    console.log(`üîÆ Generating compatibility percentage for ${person1.name} and ${person2.name}`);
    
    // –ü—Ä–æ–º–ø—Ç —Å–æ–≥–ª–∞—Å–Ω–æ –¢–ó
    const prompt = `–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—à—å —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –ª—é–¥–µ–π. –ü–æ—Å—á–∏—Ç–∞–π –º–Ω–µ –ø—Ä–æ—Ü–µ–Ω—Ç —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –¥–ª—è ${person1.name} –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è ${person1.birthDate} –∑–Ω–∞–∫ –∑–æ–¥–∏–∞–∫–∞ ${person1.zodiacSign} –∏ ${person2.name} –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è ${person2.birthDate} –∑–Ω–∞–∫ –∑–æ–¥–∏–∞–∫–∞ ${person2.zodiacSign}. –í –æ—Ç–≤–µ—Ç–µ –ø–æ–∫–∞–∂–∏ —Ç–æ–ª—å–∫–æ –ø—Ä–æ—Ü–µ–Ω—Ç –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤.`;

    const response = await openai.chat.completions.create({
      model: "openai/gpt-4o-mini",
      messages: [{ role: "user", content: prompt }],
      max_tokens: 20,
      temperature: 0.5,
    });

    const rawContent = response.choices[0].message.content || "85%";
    
    // ‚ú® –û–ß–ò–©–ê–ï–ú –¢–ï–ö–°–¢ –û–¢ MARKDOWN-–°–ò–ú–í–û–õ–û–í
    const cleanedContent = cleanMarkdownText(rawContent);
    
    // –ò–∑–≤–ª–µ–∫–∞–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç –∏–∑ –æ—Ç–≤–µ—Ç–∞
    const percentMatch = cleanedContent.match(/(\d+)%?/);
    const percentage = percentMatch ? parseInt(percentMatch[1]) : Math.floor(Math.random() * 31) + 70; // 70-100%
    
    console.log(`‚úÖ Compatibility percentage generated: ${percentage}%`);
    
    // Track API usage
    await trackApiUsage(
      userId,
      "compatibility-percentage",
      prompt,
      cleanedContent,
      response.usage?.prompt_tokens || prompt.length,
      response.usage?.completion_tokens || cleanedContent.length
    );
    
    return Math.min(Math.max(percentage, 0), 100); // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º 0-100%
  } catch (error: any) {
    console.error("‚ùå Error generating compatibility percentage:", error);
    return Math.floor(Math.random() * 31) + 70; // Fallback: 70-100%
  }
}

// =====================================================
// –¢–ï–°–¢ –ù–ê –°–û–í–ú–ï–°–¢–ò–ú–û–°–¢–¨ (–°–û–ì–õ–ê–°–ù–û –¢–ó)
// =====================================================

export async function generateCompatibilityAnalysis(
  userId: number,
  person1: { name: string; zodiacSign: string; birthDate: string },
  person2: { name: string; zodiacSign: string; birthDate: string },
  compatibilityScore?: number
): Promise<Array<{title: string, content: string}>> {
  try {
    console.log(`üîÆ Generating compatibility analysis for ${person1.name} and ${person2.name}`);
    
    // –ü—Ä–æ–º–ø—Ç —Å–æ–≥–ª–∞—Å–Ω–æ –¢–ó
    const prompt = `–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—à—å —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –ª—é–¥–µ–π, –ø—Ä–æ—Å—á–∏—Ç–∞–π –º–Ω–µ –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫—É—é, –Ω—É–º–µ—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫—É—é –∏ –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫—É—é –ª—é–±–æ–≤–Ω—É—é (–¥—Ä—É–∂–µ—Å–∫—É—é, –ø–∞—Ä—Ç–Ω–µ—Ä—Å–∫—É—é) —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å ${person1.name} –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è ${person1.birthDate} –∑–Ω–∞–∫ –∑–æ–¥–∏–∞–∫–∞ ${person1.zodiacSign} –∏ ${person2.name} –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è ${person2.birthDate} –∑–Ω–∞–∫ –∑–æ–¥–∏–∞–∫–∞ ${person2.zodiacSign}. –°–¥–µ–ª–∞–π —ç—Ç–æ –ø–æ–Ω—è—Ç–Ω—ã–º –∞–Ω–∞–ª–∏–∑–æ–º —Å —Ñ–∞–∫—Ç–∞–º–∏ –∏ —Ç–æ—á–∫–∞–º–∏ —Ä–æ—Å—Ç–∞. –í –∫–æ–Ω—Ü–µ —Å–≤–æ–µ–≥–æ –æ—Ç–≤–µ—Ç–∞ –Ω–µ –∑–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å–æ–≤. –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π –æ—Ç–≤–µ—Ç –ø–æ —Ä–∞–∑–¥–µ–ª–∞–º: —Å–Ω–∞—á–∞–ª–∞ ¬´–ê—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å¬ª, –∑–∞—Ç–µ–º ¬´–ù—É–º–µ—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å¬ª, –∑–∞—Ç–µ–º ¬´–ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å¬ª. –ö–∞–∂–¥—ã–π —Ä–∞–∑–¥–µ–ª –Ω–∞—á–∏–Ω–∞–π —Å –Ω–∞–∑–≤–∞–Ω–∏—è —Ä–∞–∑–¥–µ–ª–∞. –í–Ω—É—Ç—Ä–∏ —Ä–∞–∑–¥–µ–ª–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–∏ –∏ —Å–ø–∏—Å–∫–∏ –¥–ª—è –ª—É—á—à–µ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏.`;

    const response = await openai.chat.completions.create({
      model: "openai/gpt-4o-mini",
      messages: [{ role: "user", content: prompt }],
      max_tokens: 5000,
      temperature: 0.7,
    });

    const rawContent = response.choices[0].message.content || "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∞–Ω–∞–ª–∏–∑ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.";
    
    // ‚ú® –°–¢–†–£–ö–¢–£–†–ò–†–£–ï–ú –¢–ï–ö–°–¢ –í –°–ï–ö–¶–ò–ò (–ö–ê–ö –í –¢–ê–†–û)
    const structuredSections = cleanStructuredRussianText(rawContent);
    
    console.log(`‚úÖ Compatibility analysis generated successfully`);
    console.log(`üßπ Text structured into ${structuredSections.length} sections`);
    
    // Track API usage
    await trackApiUsage(
      userId,
      "compatibility-analysis",
      prompt,
      rawContent,
      response.usage?.prompt_tokens || prompt.length,
      response.usage?.completion_tokens || rawContent.length
    );
    
    return structuredSections;
  } catch (error: any) {
    console.error("‚ùå Error generating compatibility analysis:", error);
    
    if (error.status === 429) {
      throw new Error("–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
    } else if (error.status === 401) {
      throw new Error("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ API.");
    } else if (error.status >= 500) {
      throw new Error("–í—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ä–≤–∏—Å–æ–º. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
    }
    
    throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∞–Ω–∞–ª–∏–∑ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
  }
}

// =====================================================
// –ü–†–ï–°–ï–¢–´ –î–õ–Ø –¢–ê–†–û (–°–û–ì–õ–ê–°–ù–û –¢–ó)
// =====================================================

interface TarotPreset {
  id: string;
  name: string;
  cards3: string[];
  cards5: string[];
}

const TAROT_PRESETS: Record<string, TarotPreset[]> = {
  "love": [
    {
      id: "love-1",
      name: "–ü—Ä–æ—à–ª–æ–µ-–ù–∞—Å—Ç–æ—è—â–µ–µ-–ë—É–¥—É—â–µ–µ",
      cards3: ["–ü—Ä–æ—à–ª–æ–µ", "–ù–∞—Å—Ç–æ—è—â–µ–µ", "–ë—É–¥—É—â–µ–µ"],
      cards5: ["–ú–æ–∏ –∂–µ–ª–∞–Ω–∏—è", "–ß—Ç–æ —è –¥–∞—é", "–ß—Ç–æ –ø–æ–ª—É—á–∞—é", "–ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è", "–ò—Ç–æ–≥"]
    },
    {
      id: "love-2", 
      name: "–ß—É–≤—Å—Ç–≤–∞ –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤",
      cards3: ["–ú–æ–∏ —á—É–≤—Å—Ç–≤–∞", "–ß—É–≤—Å—Ç–≤–∞ –ø–∞—Ä—Ç–Ω—ë—Ä–∞", "–°–æ–≤–µ—Ç"],
      cards5: ["–ù–∞—Å—Ç–æ—è—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è", "–í–∑–≥–ª—è–¥ –ø–∞—Ä—Ç–Ω—ë—Ä–∞", "–í–∑–≥–ª—è–¥ –º–µ–Ω—è", "–°–æ–≤–µ—Ç", "–ë—É–¥—É—â–µ–µ"]
    },
    {
      id: "love-3",
      name: "–û–∂–∏–¥–∞–Ω–∏—è vs –†–µ–∞–ª—å–Ω–æ—Å—Ç—å",
      cards3: ["–ú–æ–∏ –æ–∂–∏–¥–∞–Ω–∏—è", "–†–µ–∞–ª—å–Ω–æ—Å—Ç—å", "–ò—Ç–æ–≥"],
      cards5: ["–ú–æ–∏ —ç–º–æ—Ü–∏–∏", "–≠–º–æ—Ü–∏–∏ –ø–∞—Ä—Ç–Ω—ë—Ä–∞", "–ß—Ç–æ –º–µ–∂–¥—É –Ω–∞–º–∏", "–ß—Ç–æ –º–µ—à–∞–µ—Ç", "–ò—Ç–æ–≥"]
    },
    {
      id: "love-4",
      name: "–ö–æ–Ω—Ñ–ª–∏–∫—Ç –∏ —Ä–µ—à–µ–Ω–∏–µ",
      cards3: ["–ü—Ä–∏—á–∏–Ω–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞", "–ß—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç", "–°–æ–≤–µ—Ç"],
      cards5: ["–õ—é–±–æ–≤—å —Å–µ–π—á–∞—Å", "–ß—Ç–æ —Å—Ç–æ–∏—Ç —Ä–∞–∑–≤–∏–≤–∞—Ç—å", "–ß—Ç–æ –æ—Ç–ø—É—Å—Ç–∏—Ç—å", "–ß–µ–≥–æ –±–æ—é—Å—å", "–ü–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã"]
    },
    {
      id: "love-5",
      name: "–í–∑–∞–∏–º–Ω—ã–π –æ–±–º–µ–Ω",
      cards3: ["–ß—Ç–æ —è –¥–∞—é", "–ß—Ç–æ —è –ø–æ–ª—É—á–∞—é", "–ß—Ç–æ –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å"],
      cards5: ["–ù–∞—á–∞–ª–æ –æ—Ç–Ω–æ—à–µ–Ω–∏–π", "–ò—Ö —Ä–∞–∑–≤–∏—Ç–∏–µ", "–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ", "–ß—Ç–æ —Å–∫—Ä—ã—Ç–æ", "–°–æ–≤–µ—Ç"]
    }
  ],
  "career": [
    {
      id: "career-1",
      name: "–ü—Ä–æ—à–ª–æ–µ-–ù–∞—Å—Ç–æ—è—â–µ–µ-–ë—É–¥—É—â–µ–µ",
      cards3: ["–ü—Ä–æ—à–ª–æ–µ", "–ù–∞—Å—Ç–æ—è—â–µ–µ", "–ë—É–¥—É—â–µ–µ –∫–∞—Ä—å–µ—Ä—ã"],
      cards5: ["–¶–µ–ª—å", "–†–µ—Å—É—Ä—Å—ã", "–ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è", "–î–µ–π—Å—Ç–≤–∏—è", "–ò—Ç–æ–≥"]
    },
    {
      id: "career-2",
      name: "–°–∏–ª—ã –∏ —Å–ª–∞–±–Ω–æ—Å—Ç–∏",
      cards3: ["–ú–æ–∏ —Å–∏–ª—ã", "–ú–æ–∏ —Å–ª–∞–±–æ—Å—Ç–∏", "–°–æ–≤–µ—Ç –¥–ª—è —Ä–æ—Å—Ç–∞"],
      cards5: ["–ú–æ–∏ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏", "–ú–æ—Ç–∏–≤–∞—Ü–∏—è", "–í–ª–∏—è–Ω–∏–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è", "–ß—Ç–æ –º–µ—à–∞–µ—Ç", "–°–æ–≤–µ—Ç"]
    },
    {
      id: "career-3",
      name: "–¶–µ–ª–∏ –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏",
      cards3: ["–ú–æ–∏ —Ü–µ–ª–∏", "–ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è", "–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏"],
      cards5: ["–¢–µ–∫—É—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è", "–ß—Ç–æ —è –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É—é", "–ß—Ç–æ –Ω–µ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É—é", "–ß—Ç–æ —É–ª—É—á—à–∏—Ç—å", "–ë—É–¥—É—â–µ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ"]
    },
    {
      id: "career-4",
      name: "–í–∑–≥–ª—è–¥ –æ–∫—Ä—É–∂–µ–Ω–∏—è",
      cards3: ["–°–∏—Ç—É–∞—Ü–∏—è —Å–µ–π—á–∞—Å", "–ö–∞–∫ –º–µ–Ω—è –≤–∏–¥—è—Ç –∫–æ–ª–ª–µ–≥–∏/—Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ", "–í–ª–∏—è–Ω–∏–µ —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã"],
      cards5: ["–ú–æ–∏ —Ü–µ–ª–∏", "–ü–ª–∞–Ω—ã", "–í—ã–∑–æ–≤—ã", "–ü–æ–¥–¥–µ—Ä–∂–∫–∞", "–ò—Ç–æ–≥"]
    },
    {
      id: "career-5",
      name: "–î–≤–∏–∂–µ–Ω–∏–µ –≤–ø–µ—Ä–µ–¥",
      cards3: ["–ß—Ç–æ —è –¥–æ–ª–∂–µ–Ω –æ—Ç–ø—É—Å—Ç–∏—Ç—å", "–ß—Ç–æ –¥–µ—Ä–∂–∏—Ç –º–µ–Ω—è", "–ß—Ç–æ –ø–æ–º–æ–∂–µ—Ç –¥–≤–∏–≥–∞—Ç—å—Å—è –≤–ø–µ—Ä—ë–¥"],
      cards5: ["–ö–ª—é—á–µ–≤–∞—è –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏—è", "–õ–∏—á–Ω—ã–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª", "–í–Ω–µ—à–Ω–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏", "–†–∏—Å–∫–∏", "–°–æ–≤–µ—Ç –¥–ª—è —É–∫—Ä–µ–ø–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏"]
    }
  ],
  "spirituality": [
    {
      id: "spirituality-1",
      name: "–î—É—Ö–æ–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ",
      cards3: ["–¢–µ–∫—É—â–µ–µ –¥—É—Ö–æ–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ", "–í—ã–∑–æ–≤", "–°–æ–≤–µ—Ç"],
      cards5: ["–ù–∞—Å—Ç–æ—è—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ", "–ò—Å—Ç–æ–∫–∏", "–í—ã–∑–æ–≤—ã", "–ü–æ–¥–¥–µ—Ä–∂–∫–∞", "–ü—É—Ç—å"]
    },
    {
      id: "spirituality-2",
      name: "–û—Å–æ–∑–Ω–∞–Ω–∏–µ",
      cards3: ["–ß—Ç–æ —è –æ—Å–æ–∑–Ω–∞—é", "–ß—Ç–æ —Å–∫—Ä—ã—Ç–æ", "–ß—Ç–æ –Ω—É–∂–Ω–æ –ø—Ä–∏–Ω—è—Ç—å"],
      cards5: ["–û—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç—å", "–ü–æ–¥—Å–æ–∑–Ω–∞–Ω–∏–µ", "–í–Ω–µ—à–Ω–∏–µ –≤–ª–∏—è–Ω–∏—è", "–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —É—á–∏—Ç–µ–ª—å", "–°–æ–≤–µ—Ç"]
    },
    {
      id: "spirituality-3",
      name: "–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –º–∏—Ä",
      cards3: ["–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –º–∏—Ä", "–í–Ω–µ—à–Ω–∏–µ –≤–ª–∏—è–Ω–∏—è", "–ü—É—Ç—å –≤–ø–µ—Ä–µ–¥"],
      cards5: ["–ú–æ–∏ —Å–æ–º–Ω–µ–Ω–∏—è", "–ú–æ—è –≤–µ—Ä–∞", "–ß—Ç–æ –¥–µ—Ä–∂–∏—Ç –º–µ–Ω—è", "–ß—Ç–æ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç", "–ò—Ç–æ–≥ –¥—É—Ö–æ–≤–Ω–æ–≥–æ –ø—É—Ç–∏"]
    },
    {
      id: "spirituality-4",
      name: "–ë–∞–ª–∞–Ω—Å",
      cards3: ["–ß—Ç–æ –º–Ω–µ –ø–æ–º–æ–≥–∞–µ—Ç", "–ß—Ç–æ –º–µ—à–∞–µ—Ç", "–ü—É—Ç—å –∫ –±–∞–ª–∞–Ω—Å—É"],
      cards5: ["–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç", "–ü—Ä–∏—á–∏–Ω–∞", "–ü—É—Ç—å –∏—Å—Ü–µ–ª–µ–Ω–∏—è", "–ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏", "–°–æ–≤–µ—Ç—ã –¥–ª—è –≥–∞—Ä–º–æ–Ω–∏–∏"]
    },
    {
      id: "spirituality-5",
      name: "–î—É—Ö–æ–≤–Ω—ã–π –ø—É—Ç—å",
      cards3: ["–ß—Ç–æ —è –º–æ–≥—É –æ—Ç–ø—É—Å—Ç–∏—Ç—å", "–ß—Ç–æ –º–Ω–µ –≤–∞–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å", "–ß—Ç–æ –æ—Ç–∫—Ä—ã—Ç—å –¥–ª—è —Å–µ–±—è"],
      cards5: ["–ü—Ä–æ—à–ª–æ–µ", "–ù–∞—Å—Ç–æ—è—â–µ–µ", "–ë—É–¥—É—â–µ–µ", "–£—Ä–æ–∫", "–ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å"]
    }
  ],
  "money": [
    {
      id: "finances-1",
      name: "–§–∏–Ω–∞–Ω—Å–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ",
      cards3: ["–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ", "–ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è", "–°–æ–≤–µ—Ç"],
      cards5: ["–¢–µ–∫—É—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è", "–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–æ—Ö–æ–¥–∞", "–û–±–ª–∞—Å—Ç–∏ —Ä–∞—Å—Ö–æ–¥–∞", "–ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è", "–°–æ–≤–µ—Ç"]
    },
    {
      id: "finances-2",
      name: "–î–æ—Ö–æ–¥—ã –∏ —Ä–∞—Å—Ö–æ–¥—ã",
      cards3: ["–î–æ—Ö–æ–¥—ã", "–†–∞—Å—Ö–æ–¥—ã", "–ü–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã"],
      cards5: ["–ú–æ–∏ —Ä–µ—Å—É—Ä—Å—ã", "–ß—Ç–æ –Ω—É–∂–Ω–æ –æ—Ç–ø—É—Å—Ç–∏—Ç—å", "–†–∏—Å–∫–∏", "–ù–æ–≤—ã–π –ø—É—Ç—å", "–†–µ–∑—É–ª—å—Ç–∞—Ç"]
    },
    {
      id: "finances-3",
      name: "–ö–æ–Ω—Ç—Ä–æ–ª—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤",
      cards3: ["–ß—Ç–æ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É—é", "–ß—Ç–æ –Ω–µ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É—é", "–ß—Ç–æ –∏–∑–º–µ–Ω–∏—Ç—å"],
      cards5: ["–¶–µ–ª–∏", "–ü–ª–∞–Ω—ã", "–ü–æ–¥–¥–µ—Ä–∂–∫–∞", "–ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è", "–ò—Ç–æ–≥"]
    },
    {
      id: "finances-4",
      name: "–†–∏—Å–∫–∏ –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏",
      cards3: ["–†–∏—Å–∫–∏", "–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏", "–î–µ–π—Å—Ç–≤–∏—è"],
      cards5: ["–í–ª–∏—è–Ω–∏–µ –ø—Ä–æ—à–ª–æ–≥–æ", "–ù–∞—Å—Ç–æ—è—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ", "–ë—É–¥—É—â–µ–µ", "–í–ª–∏—è–Ω–∏–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è", "–°–æ–≤–µ—Ç"]
   },
   {
     id: "finances-5",
     name: "–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø—Ä–∏–≤—ã—á–∫–∏",
     cards3: ["–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø—Ä–∏–≤—ã—á–∫–∏", "–ß—Ç–æ –º–µ—à–∞–µ—Ç", "–ß—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç"],
     cards5: ["–ú–æ–∏ —Å–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã", "–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è", "–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏", "–£–≥—Ä–æ–∑—ã", "–ö–∞–∫ –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å"]
   }
 ],
 "health": [
   {
     id: "health-1",
     name: "–ó–¥–æ—Ä–æ–≤—å–µ",
     cards3: ["–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ", "–û—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞", "–°–æ–≤–µ—Ç"],
     cards5: ["–§–∏–∑–∏—á–µ—Å–∫–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ", "–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ", "–ü—Å–∏—Ö–∏—á–µ—Å–∫–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ", "–í–Ω–µ—à–Ω–∏–µ —Ñ–∞–∫—Ç–æ—Ä—ã", "–°–æ–≤–µ—Ç –¥–ª—è –±–∞–ª–∞–Ω—Å–∞"]
   },
   {
     id: "health-2",
     name: "–¢–µ–ª–æ-–≠–º–æ—Ü–∏–∏-–î—É—Ö",
     cards3: ["–¢–µ–ª–æ", "–≠–º–æ—Ü–∏–∏", "–î—É—Ö"],
     cards5: ["–°–∏–º–ø—Ç–æ–º", "–ü—Ä–∏—á–∏–Ω–∞", "–ß—Ç–æ —è –¥–µ–ª–∞—é", "–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å", "–ò—Ç–æ–≥"]
   },
   {
     id: "health-3",
     name: "–ß—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç",
     cards3: ["–ß—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç", "–ß—Ç–æ –º–µ—à–∞–µ—Ç", "–ß—Ç–æ –∏–∑–º–µ–Ω–∏—Ç—å"],
     cards5: ["–ú–æ–π —Ä–µ—Å—É—Ä—Å", "–ß—Ç–æ –∏—Å—Ç–æ—â–∞–µ—Ç", "–ü–æ–º–æ—â—å –∏–∑–≤–Ω–µ", "–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –±–∞—Ä—å–µ—Ä—ã", "–ü—É—Ç—å –∫ –∏—Å—Ü–µ–ª–µ–Ω–∏—é"]
   },
   {
     id: "health-4",
     name: "–ü—Ä–∏—á–∏–Ω—ã —Å–∏–º–ø—Ç–æ–º–æ–≤",
     cards3: ["–ü—Ä–∏—á–∏–Ω–∞ —Å–∏–º–ø—Ç–æ–º–æ–≤", "–¢–µ–∫—É—â–∏–µ –¥–µ–π—Å—Ç–≤–∏—è", "–ò—Ç–æ–≥"],
     cards5: ["–ù–∞—Å—Ç–æ—è—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ", "–í–ª–∏—è–Ω–∏–µ –ø—Ä–æ—à–ª–æ–≥–æ", "–¢–µ–∫—É—â–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è", "–ß—Ç–æ –≤–∞–∂–Ω–æ —Ä–∞–∑–≤–∏–≤–∞—Ç—å", "–ò—Ç–æ–≥ –≤—ã–∑–¥–æ—Ä–æ–≤–ª–µ–Ω–∏—è"]
   },
   {
     id: "health-5",
     name: "–≠–Ω–µ—Ä–≥–∏—è –∏ —Å—Ç—Ä–µ—Å—Å",
     cards3: ["–£—Ä–æ–≤–µ–Ω—å —ç–Ω–µ—Ä–≥–∏–∏", "–ò—Å—Ç–æ—á–Ω–∏–∫–∏ —Å—Ç—Ä–µ—Å—Å–∞", "–°–ø–æ—Å–æ–±—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è"],
     cards5: ["–¢–µ–ª–µ—Å–Ω—ã–µ –æ—â—É—â–µ–Ω–∏—è", "–≠–º–æ—Ü–∏–∏", "–ú—ã—à–ª–µ–Ω–∏–µ", "–í–Ω–µ—à–Ω–µ–µ –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏–µ", "–°–æ–≤–µ—Ç –ø–æ –±–∞–ª–∞–Ω—Å—É"]
   }
 ],
 "friendship": [
   {
     id: "friendship-1",
     name: "–Ø –∏ –¥—Ä—É–≥",
     cards3: ["–Ø", "–î—Ä—É–≥", "–°—É—Ç—å –æ—Ç–Ω–æ—à–µ–Ω–∏–π"],
     cards5: ["–Ø", "–î—Ä—É–≥", "–ù–∞—à–∏ –æ–±—â–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞", "–í—ã–∑–æ–≤—ã", "–ò—Ç–æ–≥"]
   },
   {
     id: "friendship-2",
     name: "–í–∑–∞–∏–º–Ω—ã–π –æ–±–º–µ–Ω",
     cards3: ["–ß—Ç–æ —è –¥–∞—é", "–ß—Ç–æ –ø–æ–ª—É—á–∞—é", "–ß—Ç–æ –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å"],
     cards5: ["–ü–æ–∑–∏—Ç–∏–≤–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã", "–ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è", "–í–Ω–∏–º–∞–Ω–∏–µ", "–°–æ–≤–µ—Ç—ã", "–ü–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã"]
   },
   {
     id: "friendship-3",
     name: "–ö–æ–Ω—Ñ–ª–∏–∫—Ç –≤ –¥—Ä—É–∂–±–µ",
     cards3: ["–ü—Ä–∏—á–∏–Ω–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞", "–ß—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç", "–°–æ–≤–µ—Ç"],
     cards5: ["–ú–æ–∏ –æ–∂–∏–¥–∞–Ω–∏—è", "–û–∂–∏–¥–∞–Ω–∏—è –¥—Ä—É–≥–∞", "–ß—Ç–æ –Ω–∞—Å —Å–æ–µ–¥–∏–Ω—è–µ—Ç", "–ß—Ç–æ –Ω–∞—Å —Ä–∞–∑–¥–µ–ª—è–µ—Ç", "–ò—Ç–æ–≥"]
   },
   {
     id: "friendship-4",
     name: "–û–∂–∏–¥–∞–Ω–∏—è",
     cards3: ["–ú–æ–∏ –æ–∂–∏–¥–∞–Ω–∏—è", "–†–µ–∞–ª—å–Ω–æ—Å—Ç—å", "–ò—Ç–æ–≥"],
     cards5: ["–ò—Å—Ç–æ–∫–∏ –¥—Ä—É–∂–±—ã", "–ù–∞—Å—Ç–æ—è—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ", "–í–ª–∏—è–Ω–∏–µ –≤–Ω–µ—à–Ω–∏—Ö –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤", "–ß—Ç–æ —É–ª—É—á—à–∏—Ç—å", "–°–æ–≤–µ—Ç"]
   },
   {
     id: "friendship-5",
     name: "–ë—É–¥—É—â–µ–µ –¥—Ä—É–∂–±—ã",
     cards3: ["–ù–∞—Å—Ç–æ—è—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ", "–í–ª–∏—è–Ω–∏–µ –ø—Ä–æ—à–ª–æ–≥–æ", "–ë—É–¥—É—â–µ–µ –¥—Ä—É–∂–±—ã"],
     cards5: ["–Ø", "–î—Ä—É–≥", "–ù–∞—à–∏ –Ω–∞—Å—Ç–æ—è—â–∏–µ —á—É–≤—Å—Ç–≤–∞", "–ë–∞—Ä—å–µ—Ä—ã", "–ö–∞–∫ –¥–≤–∏–≥–∞—Ç—å—Å—è –≤–ø–µ—Ä—ë–¥"]
   }
 ]
};

// 22 –∫–∞—Ä—Ç—ã —Å—Ç–∞—Ä—à–∏—Ö –∞—Ä–∫–∞–Ω–æ–≤
const MAJOR_ARCANA = [
 "–î—É—Ä–∞–∫", "–ú–∞–≥", "–í–µ—Ä—Ö–æ–≤–Ω–∞—è –ñ—Ä–∏—Ü–∞", "–ò–º–ø–µ—Ä–∞—Ç—Ä–∏—Ü–∞", "–ò–º–ø–µ—Ä–∞—Ç–æ—Ä", "–ò–µ—Ä–æ—Ñ–∞–Ω—Ç",
 "–í–ª—é–±–ª–µ–Ω–Ω—ã–µ", "–ö–æ–ª–µ—Å–Ω–∏—Ü–∞", "–°–∏–ª–∞", "–û—Ç—à–µ–ª—å–Ω–∏–∫", "–ö–æ–ª–µ—Å–æ –§–æ—Ä—Ç—É–Ω—ã", "–°–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç—å",
 "–ü–æ–≤–µ—à–µ–Ω–Ω—ã–π", "–°–º–µ—Ä—Ç—å", "–£–º–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å", "–î—å—è–≤–æ–ª", "–ë–∞—à–Ω—è", "–ó–≤–µ–∑–¥–∞", 
 "–õ—É–Ω–∞", "–°–æ–ª–Ω—Ü–µ", "–°—É–¥", "–ú–∏—Ä"
];

// =====================================================
// –†–ê–°–ö–õ–ê–î –¢–ê–†–û (–°–û–ì–õ–ê–°–ù–û –¢–ó)
// =====================================================

export async function generateTarotReading(
 userId: number, 
 question: string, 
 cardCount: number, 
 category: string, 
 selectedCards?: string[]
): Promise<Array<{title: string, content: string}>> {
 try {
   console.log(`üîÆ Generating tarot reading: ${cardCount} cards, category: ${category}`);
   
   const user = await getUserData(userId);
   const userName = user?.name || "–î—Ä—É–≥";
   const userGender = user?.gender || "–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω";
   const birthDate = user?.birthDate || "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞";
   
   // –ü–æ–ª—É—á–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–π –ø—Ä–µ—Å–µ—Ç –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
   const categoryPresets = TAROT_PRESETS[category] || TAROT_PRESETS["love"];
   const randomPreset = categoryPresets[Math.floor(Math.random() * categoryPresets.length)];
   
   // –í—ã–±–∏—Ä–∞–µ–º –ø—Ä–µ—Å–µ—Ç—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–∞—Ä—Ç
   const presets = cardCount === 5 ? randomPreset.cards5 : randomPreset.cards3;
   
   // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–µ –∫–∞—Ä—Ç—ã –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–æ–≤
   const shuffledCards = [...MAJOR_ARCANA].sort(() => Math.random() - 0.5);
   const drawnCards = shuffledCards.slice(0, cardCount);
   
   console.log(`üé¥ Selected preset: ${randomPreset.name}`);
   console.log(`üé¥ Drawn cards: ${drawnCards.join(', ')}`);
   
   // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É —Å –∫–∞—Ä—Ç–∞–º–∏ –∏ –∏—Ö –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
   let cardsString = "";
   for (let i = 0; i < cardCount; i++) {
     cardsString += `–∫–∞—Ä—Ç–∞ ${i + 1} –æ–±–æ–∑–Ω–∞—á–∞–µ—Ç ¬´${presets[i]}¬ª - —ç—Ç–æ –∫–∞—Ä—Ç–∞ ${drawnCards[i]}`;
     if (i < cardCount - 1) cardsString += ", ";
   }
   
   // –ü—Ä–æ–º–ø—Ç —Å–æ–≥–ª–∞—Å–Ω–æ –¢–ó —Å –æ—á–∏—Å—Ç–∫–æ–π –æ—Ç markdown
   const prompt = cardCount === 3 
     ? `–ü—Ä–µ–¥—Å—Ç–∞–≤—å, —á—Ç–æ —Ç—ã –æ–ø—ã—Ç–Ω—ã–π —Ç–∞—Ä–æ–ª–æ–≥ —Å –≥–ª—É–±–æ–∫–∏–º –ø–æ–Ω–∏–º–∞–Ω–∏–µ–º —Å–∏–º–≤–æ–ª–∏–∑–º–∞ –∏ —Ç–æ–Ω–∫–æ—Å—Ç–µ–π –∫–∞—Ä—Ç –¢–∞—Ä–æ. –¢—ã –ø–æ–º–æ–≥–∞–µ—à—å –ª—é–¥—è–º –æ–±—Ä–µ—Ç–∞—Ç—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é –≥–∞—Ä–º–æ–Ω–∏—é –∏ –Ω–∞—Ö–æ–¥–∏—Ç—å –æ—Ç–≤–µ—Ç—ã –Ω–∞ –≤–∞–∂–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã —Å–≤–æ–µ–π –∂–∏–∑–Ω–∏. –ü—Ä–µ–∂–¥–µ —á–µ–º –Ω–∞—á–∞—Ç—å, —Å–æ–∑–¥–∞–≤–∞–π —Å–ø–æ–∫–æ–π–Ω—É—é –∏ –¥–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω—É—é –∞—Ç–º–æ—Å—Ñ–µ—Ä—É, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–≥ —Å–æ—Å—Ä–µ–¥–æ—Ç–æ—á–∏—Ç—å—Å—è –Ω–∞ —Å–≤–æ–µ–º –∑–∞–ø—Ä–æ—Å–µ. –†—É–∫–æ–≤–æ–¥–∏ –µ–≥–æ –≤—ã–±–æ—Ä–æ–º –∫–∞—Ä—Ç –∏ –¥–µ–ª–∏—Å—å –∏—Ö –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è–º–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –ø—Ä–æ–ª–∏—Ç—å —Å–≤–µ—Ç –Ω–∞ –µ–≥–æ —Ç–µ–∫—É—â—É—é –∂–∏–∑–Ω–µ–Ω–Ω—É—é —Å–∏—Ç—É–∞—Ü–∏—é.

–ß–µ–ª–æ–≤–µ–∫–∞, –∫–æ—Ç–æ—Ä—ã–π –∫ —Ç–µ–±–µ –æ–±—Ä–∞—Ç–∏–ª—Å—è, –∑–æ–≤—É—Ç ${userName}, ${userGender}, –¥–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è ${birthDate}. –¢–µ–º–∞ —Ä–∞—Å–∫–ª–∞–¥–∞ -- ${category}.

–ü—Ä–æ–±–ª–µ–º–∞, –∫–æ—Ç–æ—Ä—É—é ${userName} —Ö–æ—á–µ—Ç —Ä–µ—à–∏—Ç—å: ¬´${question}¬ª.

–í—ã–ø–∞–ª–∏ —Å–ª–µ–¥—É—é—â–∏–µ –∫–∞—Ä—Ç—ã: ${cardsString}. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∫–∞—Ä—Ç—ã –≤ —Ç–æ–º –∂–µ –ø–æ—Ä—è–¥–∫–µ, –≤ –∫–æ—Ç–æ—Ä–æ–º –æ–Ω–∏ –∏ –Ω–∞–ø–∏—Å–∞–Ω—ã. –î–∞–π –ø–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ –æ–ø–∏—Å–∞–Ω–Ω—É—é –ø—Ä–æ–±–ª–µ–º—É –∏ –ø—Ä–æ–≤–µ–¥–∏ –ø–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –≤—ã—Ç—è–Ω—É—Ç—ã—Ö –∫–∞—Ä—Ç. –î–∞–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, –Ω–∞ —á—Ç–æ –Ω—É–∂–Ω–æ –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ –∏ —á–µ–≥–æ —Å—Ç–æ–∏—Ç –∏–∑–±–µ–≥–∞—Ç—å. –ù–ï –ò–°–ü–û–õ–¨–ó–£–ô markdown-—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–∑–≤–µ–∑–¥–æ—á–∫–∏, —Ä–µ—à–µ—Ç–∫–∏, –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è). –ü–∏—à–∏ –æ–±—ã—á–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º.`
     
     : `–ü—Ä–µ–¥—Å—Ç–∞–≤—å, —á—Ç–æ —Ç—ã –æ–ø—ã—Ç–Ω—ã–π —Ç–∞—Ä–æ–ª–æ–≥ —Å –≥–ª—É–±–æ–∫–∏–º –ø–æ–Ω–∏–º–∞–Ω–∏–µ–º —Å–∏–º–≤–æ–ª–∏–∑–º–∞ –∏ —Ç–æ–Ω–∫–æ—Å—Ç–µ–π –∫–∞—Ä—Ç –¢–∞—Ä–æ. –¢—ã –ø–æ–º–æ–≥–∞–µ—à—å –ª—é–¥—è–º –æ–±—Ä–µ—Ç–∞—Ç—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é –≥–∞—Ä–º–æ–Ω–∏—é –∏ –Ω–∞—Ö–æ–¥–∏—Ç—å –æ—Ç–≤–µ—Ç—ã –Ω–∞ –≤–∞–∂–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã —Å–≤–æ–µ–π –∂–∏–∑–Ω–∏. –ü—Ä–µ–∂–¥–µ —á–µ–º –Ω–∞—á–∞—Ç—å, —Å–æ–∑–¥–∞–≤–∞–π —Å–ø–æ–∫–æ–π–Ω—É—é –∏ –¥–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω—É—é –∞—Ç–º–æ—Å—Ñ–µ—Ä—É, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–≥ —Å–æ—Å—Ä–µ–¥–æ—Ç–æ—á–∏—Ç—å—Å—è –Ω–∞ —Å–≤–æ–µ–º –∑–∞–ø—Ä–æ—Å–µ. –†—É–∫–æ–≤–æ–¥–∏ –µ–≥–æ –≤—ã–±–æ—Ä–æ–º –∫–∞—Ä—Ç –∏ –¥–µ–ª–∏—Å—å –∏—Ö –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è–º–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –ø—Ä–æ–ª–∏—Ç—å —Å–≤–µ—Ç –Ω–∞ –µ–≥–æ —Ç–µ–∫—É—â—É—é –∂–∏–∑–Ω–µ–Ω–Ω—É—é —Å–∏—Ç—É–∞—Ü–∏—é.

–ß–µ–ª–æ–≤–µ–∫–∞, –∫–æ—Ç–æ—Ä—ã–π –∫ —Ç–µ–±–µ –æ–±—Ä–∞—Ç–∏–ª—Å—è, –∑–æ–≤—É—Ç ${userName}, ${userGender}, –¥–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è ${birthDate}. –¢–µ–º–∞ —Ä–∞—Å–∫–ª–∞–¥–∞ -- ${category}.

–ü—Ä–æ–±–ª–µ–º–∞, –∫–æ—Ç–æ—Ä—É—é ${userName} —Ö–æ—á–µ—Ç —Ä–µ—à–∏—Ç—å: ¬´${question}¬ª.

–í—ã–ø–∞–ª–∏ —Å–ª–µ–¥—É—é—â–∏–µ –∫–∞—Ä—Ç—ã: ${cardsString}. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∫–∞—Ä—Ç—ã –≤ —Ç–æ–º –∂–µ –ø–æ—Ä—è–¥–∫–µ, –≤ –∫–æ—Ç–æ—Ä–æ–º –æ–Ω–∏ –∏ –Ω–∞–ø–∏—Å–∞–Ω—ã. –î–∞–π –ø–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ –æ–ø–∏—Å–∞–Ω–Ω—É—é –ø—Ä–æ–±–ª–µ–º—É –∏ –ø—Ä–æ–≤–µ–¥–∏ –ø–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –≤—ã—Ç—è–Ω—É—Ç—ã—Ö –∫–∞—Ä—Ç. –î–∞–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, –Ω–∞ —á—Ç–æ –Ω—É–∂–Ω–æ –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ –∏ —á–µ–≥–æ —Å—Ç–æ–∏—Ç –∏–∑–±–µ–≥–∞—Ç—å. –ù–ï –ò–°–ü–û–õ–¨–ó–£–ô markdown-—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–∑–≤–µ–∑–¥–æ—á–∫–∏, —Ä–µ—à–µ—Ç–∫–∏, –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è). –ü–∏—à–∏ –æ–±—ã—á–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º.`;

   const response = await openai.chat.completions.create({
     model: "openai/gpt-4o-mini",
     messages: [{ role: "user", content: prompt }],
     max_tokens: 3000,
     temperature: 0.8,
   });

   const rawContent = response.choices[0].message.content || "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —á—Ç–µ–Ω–∏–µ –∫–∞—Ä—Ç. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.";
   
   // ‚ú® –°–¢–†–£–ö–¢–£–†–ò–†–£–ï–ú –¢–ï–ö–°–¢ –í –°–ï–ö–¶–ò–ò
   const structuredSections = cleanStructuredRussianText(rawContent);
   
   console.log(`‚úÖ Tarot reading generated successfully`);
   console.log(`üßπ Text structured into ${structuredSections.length} sections`);
   
   // Track API usage
   await trackApiUsage(
     userId,
     `tarot/${cardCount}/${category}`,
     prompt,
     rawContent,
     response.usage?.prompt_tokens || prompt.length,
     response.usage?.completion_tokens || rawContent.length
   );
   
   return structuredSections;
 } catch (error: any) {
   console.error("‚ùå Error generating tarot reading:", error);
   
   if (error.status === 429) {
     throw new Error("–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
   } else if (error.status === 401) {
     throw new Error("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ API.");
   } else if (error.status >= 500) {
     throw new Error("–í—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ä–≤–∏—Å–æ–º. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
   }
   
   throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —á—Ç–µ–Ω–∏–µ –∫–∞—Ä—Ç. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
 }
}

// =====================================================
// –ù–ê–¢–ê–õ–¨–ù–ê–Ø –ö–ê–†–¢–ê (–°–û–ì–õ–ê–°–ù–û –¢–ó)
// =====================================================

export async function generateNatalChartAnalysis(
  userId: number, 
  name: string, 
  birthDate: string, 
  birthTime?: string, 
  birthPlace?: string
): Promise<Array<{title: string, content: string}>> {
  try {
    console.log(`üîÆ Generating natal chart analysis for ${name}`);
    
    // –ü—Ä–æ–º–ø—Ç –¥–ª—è –Ω–∞—Ç–∞–ª—å–Ω–æ–π –∫–∞—Ä—Ç—ã (–º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –±–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω–æ)
    const prompt = `–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞—Å—Ç—Ä–æ–ª–æ–≥. –°–æ–∑–¥–∞–π –ø–æ–¥—Ä–æ–±–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –Ω–∞—Ç–∞–ª—å–Ω–æ–π –∫–∞—Ä—Ç—ã –¥–ª—è —á–µ–ª–æ–≤–µ–∫–∞ —Å –∏–º–µ–Ω–µ–º ${name}, —Ä–æ–¥–∏–≤—à–µ–≥–æ—Å—è ${birthDate}${birthTime ? ` –≤ ${birthTime}` : ""}${birthPlace ? ` –≤ –≥–æ—Ä–æ–¥–µ ${birthPlace}` : ""}. 

–í–∫–ª—é—á–∏ –≤ –∞–Ω–∞–ª–∏–∑:
1. –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫—É –ª–∏—á–Ω–æ—Å—Ç–∏ –ø–æ –∑–Ω–∞–∫—É –∑–æ–¥–∏–∞–∫–∞
2. –í–ª–∏—è–Ω–∏–µ –ø–ª–∞–Ω–µ—Ç –Ω–∞ —Ö–∞—Ä–∞–∫—Ç–µ—Ä –∏ —Å—É–¥—å–±—É
3. –°–∏–ª—å–Ω—ã–µ –∏ —Å–ª–∞–±—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã –ª–∏—á–Ω–æ—Å—Ç–∏
4. –¢–∞–ª–∞–Ω—Ç—ã –∏ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
5. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –∂–∏–∑–Ω–µ–Ω–Ω–æ–≥–æ –ø—É—Ç–∏
6. –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å –¥—Ä—É–≥–∏–º–∏ –∑–Ω–∞–∫–∞–º–∏
7. –ë–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω—ã–µ –ø–µ—Ä–∏–æ–¥—ã –∏ —á–∏—Å–ª–∞

–ò—Å–ø–æ–ª—å–∑—É–π –º–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –∏ –¥—É—Ö–æ–≤–Ω—ã–π —Ç–æ–Ω, –Ω–æ –±—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –≤ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è—Ö. –ü–∏—à–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –ù–ï –ò–°–ü–û–õ–¨–ó–£–ô markdown-—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–∑–≤–µ–∑–¥–æ—á–∫–∏, —Ä–µ—à–µ—Ç–∫–∏, –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è). –ü–∏—à–∏ –æ–±—ã—á–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º.`;

    const response = await openai.chat.completions.create({
      model: "openai/gpt-4o-mini",
      messages: [{ role: "user", content: prompt }],
      max_tokens: 800,
      temperature: 0.7,
    });

    const rawContent = response.choices[0].message.content || "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∞–Ω–∞–ª–∏–∑ –Ω–∞—Ç–∞–ª—å–Ω–æ–π –∫–∞—Ä—Ç—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.";
    
    // ‚ú® –°–¢–†–£–ö–¢–£–†–ò–†–£–ï–ú –¢–ï–ö–°–¢ –í –°–ï–ö–¶–ò–ò (–ö–ê–ö –í –¢–ê–†–û)
    const structuredSections = cleanStructuredRussianText(rawContent);
    
    console.log(`‚úÖ Natal chart analysis generated successfully for ${name}`);
    console.log(`üßπ Text structured into ${structuredSections.length} sections`);
    
    // Track API usage
    await trackApiUsage(
      userId,
      "natal-chart",
      prompt,
      rawContent,
      response.usage?.prompt_tokens || prompt.length,
      response.usage?.completion_tokens || rawContent.length
    );
    
    return structuredSections;
  } catch (error: any) {
    console.error("‚ùå Error generating natal chart analysis:", error);
    
    if (error.status === 429) {
      throw new Error("–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
    } else if (error.status === 401) {
      throw new Error("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ API.");
    } else if (error.status >= 500) {
      throw new Error("–í—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ä–≤–∏—Å–æ–º. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
    }
    
    throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∞–Ω–∞–ª–∏–∑ –Ω–∞—Ç–∞–ª—å–Ω–æ–π –∫–∞—Ä—Ç—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
  }
}

// =====================================================
// –¢–ï–°–¢–û–í–´–ï –ò –°–õ–£–ñ–ï–ë–ù–´–ï –§–£–ù–ö–¶–ò–ò
// =====================================================

// Test OpenRouter connection
export async function testOpenAIConnection(): Promise<boolean> {
 try {
   console.log('üîß Testing OpenRouter connection...');
   
   const response = await openai.chat.completions.create({
     model: 'openai/gpt-4o-mini',
     messages: [{ role: 'user', content: 'Test' }],
     max_tokens: 5,
   });
   
   console.log('‚úÖ OpenRouter connection test successful!');
   return true;
 } catch (error: any) {
   console.error('‚ùå OpenRouter connection test failed:', error.message);
   return false;
 }
}

// Health check function for monitoring
export async function healthCheck(): Promise<{ status: string; openai: boolean; timestamp: string }> {
 const isOpenAIWorking = await testOpenAIConnection();
 
 return {
   status: isOpenAIWorking ? 'healthy' : 'degraded',
   openai: isOpenAIWorking,
   timestamp: new Date().toISOString()
 };
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–µ—Å–µ—Ç–æ–≤ (–¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞)
export function getTarotPresets(category: string): TarotPreset[] {
 return TAROT_PRESETS[category] || TAROT_PRESETS["love"];
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
export function getTarotCategories(): string[] {
 return Object.keys(TAROT_PRESETS);
}